{"version":3,"sources":["webpack://dcmjs/./adapters/Cornerstone/Segmentation.js"],"names":["Segmentation","imageIds","images","brushData","console","log","toolState","segments","datasets","image0","dims","x","columns","y","rows","z","length","xy","xyz","multiframe","includes","seg","createSegFromImages","addMetaDataToSeg","masks","segIdx","imageIdSpecificToolState","brsuh","brush","data","dataSet","dataset","numSegments","i","addSegment","isMultiframe","image","arrayBuffer","byteArray","buffer","dicomData","dcmjs","DicomMessage","readFile","DicomMetaDictionary","naturalizeDataset","dict","_meta","namifyDataset","meta","push","normalizers","Normalizer","normalizeToDataset","derivations","Columns","Rows","segmentSequence","SegmentSequence","pixelData","BitArray","unpack","PixelData","segMetadata","seriesInstanceUid","SeriesInstanceUid","Array","isArray","segCount","imageId","invalidated","Uint8ClampedArray","cToolsPixelData","p"],"mappings":"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","file":"dcmjs.fffb35e5010257247778.hot-update.js","sourcesContent":["export default class Segmentation {\n  constructor() {}\n\n  static generateToolState(imageIds, images, brushData) {\n    // NOTE: here be dragons. Currently if a brush has been used and then erased,\n    // This will flag up as a segmentation, even though its full of zeros.\n    // Fixing this cleanly really requires an update of cornerstoneTools.\n\n    console.log(\"testButton\");\n\n    const { toolState, segments } = brushData;\n\n    console.log(\"test2\");\n\n    const datasets = [];\n\n    console.log(images);\n\n    const image0 = images[0];\n\n    const dims = {\n      x: image0.columns,\n      y: image0.rows,\n      z: imageIds.length\n    };\n\n    dims.xy = dims.x * dims.y;\n    dims.xyz = dims.xy * dims.z;\n\n    const multiframe = imageIds[0].includes(\"?frame\");\n\n    const seg = Segmentation.createSegFromImages(images, multiframe);\n    Segmentation.addMetaDataToSeg(seg, segments);\n\n    const masks = [];\n\n    for (let segIdx = 0; segIdx < segments.length; segIdx++) {\n      if (!segments[segIdx]) {\n        continue;\n      }\n\n      for (let z = 0; z < imageIds.length; z++) {\n        const imageIdSpecificToolState = toolState[imageIds[z]];\n\n        if (\n          imageIdSpecificToolState.brsuh &&\n          imageIdSpecificToolState.brush.data\n        ) {\n          const brushData = imageIdSpecificToolState.brush.data;\n        }\n      }\n    }\n\n    const dataSet = seg.dataset;\n\n    let numSegments = 0;\n\n    // TODO -> save pixel data to seg.pixelData\n  }\n\n  static addMetaDataToSeg(seg, segments) {\n    for (let i = 0; i < segments.length; i++) {\n      if (segments[i]) {\n        numSegments++;\n\n        seg.addSegment(segments[i]);\n      }\n    }\n  }\n\n  /**\n   * @static createSegFromImages - description\n   *\n   * @param  {object} images       description\n   * @param  {Boolean} isMultiframe description\n   * @returns {dataSet}              description\n   */\n  static createSegFromImages(images, isMultiframe) {\n    if (isMultiframe) {\n      const image = images[0];\n      const arrayBuffer = image.data.byteArray.buffer;\n\n      const dicomData = dcmjs.data.DicomMessage.readFile(arrayBuffer);\n      const dataset = dcmjs.data.DicomMetaDictionary.naturalizeDataset(\n        dicomData.dict\n      );\n\n      dataset._meta = dcmjs.data.DicomMetaDictionary.namifyDataset(\n        dicomData.meta\n      );\n\n      datasets.push(dataset);\n    } else {\n      for (let i = 0; i < images.length; i++) {\n        const image = images[i];\n        const arrayBuffer = image.data.byteArray.buffer;\n        const dicomData = dcmjs.data.DicomMessage.readFile(arrayBuffer);\n        const dataset = dcmjs.data.DicomMetaDictionary.naturalizeDataset(\n          dicomData.dict\n        );\n\n        dataset._meta = dcmjs.data.DicomMetaDictionary.namifyDataset(\n          dicomData.meta\n        );\n        datasets.push(dataset);\n      }\n    }\n\n    const multiframe = dcmjs.normalizers.Normalizer.normalizeToDataset(\n      datasets\n    );\n\n    return new dcmjs.derivations.Segmentation([multiframe]);\n  }\n\n  static readToolState(imageIds, arrayBuffer) {\n    dicomData = dcmjs.data.DicomMessage.readFile(arrayBuffer);\n    let dataset = dcmjs.data.DicomMetaDictionary.naturalizeDataset(\n      dicomData.dict\n    );\n    dataset._meta = dcmjs.data.DicomMetaDictionary.namifyDataset(\n      dicomData.meta\n    );\n    const multiframe = dcmjs.normalizers.Normalizer.normalizeToDataset([\n      dataset\n    ]);\n\n    const dims = {\n      x: multiframe.Columns,\n      y: multiframe.Rows,\n      z: imageIds.length,\n      xy: multiframe.Columns * multiframe.Rows,\n      xyz: multiframe.Columns * multiframe.Rows * imageIds.length\n    };\n\n    const segmentSequence = multiframe.SegmentSequence;\n    const pixelData = dcmjs.data.BitArray.unpack(multiframe.PixelData);\n\n    //console.log(segmentSequence);\n\n    //console.log(multiframe);\n\n    const segMetadata = {\n      seriesInstanceUid: multiframe.SeriesInstanceUid,\n      data: []\n    };\n\n    const toolState = {};\n\n    if (Array.isArray(segmentSequence)) {\n      const segCount = segmentSequence.length;\n\n      for (let z = 0; z < imageIds.length; z++) {\n        const imageId = imageIds[z];\n\n        const imageIdSpecificToolState = {};\n\n        imageIdSpecificToolState.brush = {};\n        imageIdSpecificToolState.brush.data = [];\n\n        const brushData = imageIdSpecificToolState.brush.data;\n\n        for (let i = 0; i < segCount; i++) {\n          brushData[i] = {\n            invalidated: true,\n            pixelData: new Uint8ClampedArray(dims.x * dims.y)\n          };\n        }\n\n        toolState[imageId] = imageIdSpecificToolState;\n      }\n\n      for (let segIdx = 0; segIdx < segmentSequence.length; segIdx++) {\n        segMetadata.data.push(segmentSequence[segIdx]);\n\n        for (let z = 0; z < imageIds.length; z++) {\n          const imageId = imageIds[z];\n\n          const cToolsPixelData =\n            toolState[imageId].brush.data[segIdx].pixelData;\n\n          for (let p = 0; p < dims.xy; p++) {\n            cToolsPixelData[p] = pixelData[segIdx * dims.xyz + z * dims.xy + p];\n          }\n        }\n      }\n    } else {\n      // Only one segment, will be stored as an object.\n      segMetadata.data.push(segmentSequence);\n\n      const segIdx = 0;\n\n      for (let z = 0; z < imageIds.length; z++) {\n        const imageId = imageIds[z];\n\n        const imageIdSpecificToolState = {};\n\n        imageIdSpecificToolState.brush = {};\n        imageIdSpecificToolState.brush.data = [];\n        imageIdSpecificToolState.brush.data[segIdx] = {\n          invalidated: true,\n          pixelData: new Uint8ClampedArray(dims.x * dims.y)\n        };\n\n        const cToolsPixelData =\n          imageIdSpecificToolState.brush.data[segIdx].pixelData;\n\n        for (let p = 0; p < dims.xy; p++) {\n          cToolsPixelData[p] = pixelData[z * dims.xy + p];\n        }\n\n        toolState[imageId] = imageIdSpecificToolState;\n      }\n    }\n\n    //console.log(toolState);\n\n    // TODO -> return seg metadata and brush tool data.\n\n    return { toolState, segMetadata };\n  }\n}\n"],"sourceRoot":""}