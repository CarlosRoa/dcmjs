{"version":3,"sources":["webpack://dcmjs/./adapters/Cornerstone/Segmentation.js"],"names":["Segmentation","stackOfImages","toolState","segMetadata","idx","segment","modules","brush","setters","metadata","_seriesInfo","seriesInstanceUid","imageIds","arrayBuffer","dicomData","dcmjs","data","DicomMessage","readFile","dataset","DicomMetaDictionary","naturalizeDataset","dict","_meta","namifyDataset","meta","multiframe","normalizers","Normalizer","normalizeToDataset","dims","x","Columns","y","Rows","z","length","xy","xyz","segmentSequence","SegmentSequence","pixelData","BitArray","unpack","PixelData","console","log","Array","isArray","segCount","imageId","imageIdSpecificToolState","brushData","i","invalidated","Uint8ClampedArray","segIndex","push","cToolsPixelData","p"],"mappings":"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","file":"dcmjs.69e0ae7deb12c2a2cb22.hot-update.js","sourcesContent":["export default class Segmentation {\n  constructor() {}\n\n  static generateToolState(stackOfImages, toolState) {}\n\n  static _setSegMetadata(segMetadata, idx, segment) {\n    segMetadata[idx] = segment;\n\n    modules.brush.setters.metadata(\n      this._seriesInfo.seriesInstanceUid,\n      idx,\n      segment\n    );\n  }\n\n  static _addOneSegToCornerstoneToolState() {}\n\n  static readToolState(imageIds, arrayBuffer) {\n    dicomData = dcmjs.data.DicomMessage.readFile(arrayBuffer);\n    let dataset = dcmjs.data.DicomMetaDictionary.naturalizeDataset(\n      dicomData.dict\n    );\n    dataset._meta = dcmjs.data.DicomMetaDictionary.namifyDataset(\n      dicomData.meta\n    );\n    const multiframe = dcmjs.normalizers.Normalizer.normalizeToDataset([\n      dataset\n    ]);\n\n    const dims = {\n      x: multiframe.Columns,\n      y: multiframe.Rows,\n      z: imageIds.length,\n      xy: multiframe.Columns * multiframe.Rows,\n      xyz: multiframe.Columns * multiframe.Rows * imageIds.length\n    };\n\n    const segmentSequence = multiframe.SegmentSequence;\n    const pixelData = dcmjs.data.BitArray.unpack(multiframe.PixelData);\n\n    console.log(segmentSequence);\n\n    console.log(multiframe);\n\n    const segMetadata = [];\n\n    const toolState = {};\n\n    if (Array.isArray(segmentSequence)) {\n      const segCount = segmentSequence.length;\n\n      for (let z = 0; z < imageIds.length; z++) {\n        const imageId = imageIds[z];\n\n        const imageIdSpecificToolState = {};\n\n        imageIdSpecificToolState.brush = {};\n        imageIdSpecificToolState.brush.data = [];\n\n        const brushData = imageIdSpecificToolState.brush.data;\n\n        for (let i = 0; i < segCount; i++) {\n          brushData[i] = {\n            invalidated: true,\n            pixelData: new Uint8ClampedArray(dims.x * dims.y)\n          };\n        }\n\n        toolState[imageId] = imageIdSpecificToolState;\n      }\n\n      for (let segIndex = 0; segIndex < segmentSequence.length; segIndex++) {\n        segMetadata.push(segmentSequence[segIndex]);\n\n        for (let z = 0; z < imageIds.length; z++) {\n          const imageId = imageIds[z];\n\n          const cToolsPixelData =\n            toolState[imageId].brush.data[segIndex].pixelData;\n\n          for (let p = 0; p < dims.xy; p++) {\n            cToolsPixelData[p] =\n              pixelData[segIndex * dims.xyz + z * dims.xy + p];\n          }\n        }\n      }\n    } else {\n      // Only one segment, will be stored as an object.\n      segMetadata.push(segmentSequence);\n\n      const segIndex = 0;\n\n      for (let z = 0; z < imageIds.length; z++) {\n        const imageId = imageIds[z];\n\n        const imageIdSpecificToolState = {};\n\n        imageIdSpecificToolState.brush = {};\n        imageIdSpecificToolState.brush.data = [];\n        imageIdSpecificToolState.brush.data[segIndex] = {\n          invalidated: true,\n          pixelData: new Uint8ClampedArray(dims.x * dims.y)\n        };\n\n        const cToolsPixelData =\n          imageIdSpecificToolState.brush.data[segIndex].pixelData;\n\n        for (let p = 0; p < dims.xy; p++) {\n          cToolsPixelData[p] = pixelData[z * dims.xy + p];\n        }\n\n        toolState[imageId] = imageIdSpecificToolState;\n      }\n    }\n\n    console.log(toolState);\n\n    // TODO -> return seg metadata and brush tool data.\n\n    return { toolState, segMetadata };\n  }\n}\n"],"sourceRoot":""}